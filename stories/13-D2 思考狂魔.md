# 需求文档：13-D2 思考狂魔 - AI思考过程可视化

## 1. 需求背景

当前与AI交互时，部分模型在生成最终回复前需要一段处理时间（"思考过程"）。用户在这段时间内可能只看到"正在输入..."或无明显反馈，导致体验不确定，尤其在AI思考时间较长时。本需求旨在通过可视化AI的思考步骤，提升用户体验、透明度和信任感。

## 2. 需求ID与名称

*   **需求ID**: 13-D2
*   **需求名称**: 思考狂魔 - AI思考过程可视化

## 3. 目标用户

所有使用AI聊天功能的用户，特别是与那些具有复杂处理逻辑或较长响应准备时间的模型交互的用户。

## 4. 用户故事

**作为一名** AI聊天用户，
**我希望** 能够看到AI正在"思考"或"计算"的明确指示，并且可以选择查看其具体的思考步骤，
**以便于** 我能更好地理解AI的响应延迟、了解其处理逻辑，并对其最终回复建立更高的信任。

## 5. 功能详述

### 5.1. 核心流程与状态转换

1.  **用户发送消息**：用户在聊天界面发送一条消息。
2.  **初始反馈**：系统可能会短暂显示通用的"正在输入..."提示（沿用现有行为）。
3.  **进入"计算中"状态**：
    *   **触发**：当后端通过 `/queryStream` 接口推送第一个类型为"思考片段"（具体 `type` 值待后端定义）的数据时。
    *   **UI变更**：
        *   聊天界面中，原"正在输入..."提示（如果存在）更新为"正在计算..."。
        *   在AI消息预定出现的位置（通常是AI头像下方），出现一个新的可交互区域，用于展示思考内容。此区域初始状态为**折叠**。
4.  **思考内容增量加载与展示**：
    *   后续通过 `/queryStream` 接收到的"思考片段"，其内容会增量追加到上述折叠区域内。
    *   用户可以点击展开/折叠该区域，查看AI的思考步骤。
    *   即使在折叠状态，新的思考片段也应持续加载至该区域。
5.  **进入"输入中"状态（生成正文回复）**：
    *   **触发**：当后端通过 `/queryStream` 接口推送第一个类型为"正文片段"（例如，使用现有表示数据流的 `type: 1`）的数据时。
    *   **UI变更**：
        *   "正在计算..."提示变更为"正在输入..."（标准AI回复生成提示）。
        *   正文片段的内容开始流式传输到AI的主回复消息气泡中。
6.  **回复完成**：AI完成所有正文回复的流式输出。

### 5.2. 思考内容展示区

*   **位置**：建议位于AI最终回复消息气泡的上方。
*   **默认状态**：折叠。用户需要主动操作（如点击）才能展开查看详细思考步骤。
*   **内容**：按接收顺序逐条或追加显示思考片段的内容。
*   **交互**：用户可以随时展开或收起此区域。

### 5.3. 思考内容的持久性与最终可见性

*   **要求**：当AI完成所有回复（"正在输入..."结束后），之前加载的思考步骤（在折叠区域内）**应继续保留**在AI最终回复的上方（或其既定位置）。用户依然可以展开/折叠查看它们。
    *   *注：此设计旨在最大化"思考狂魔"特性对用户的价值，允许用户在对话结束后回顾AI的思考逻辑。*

### 5.4. 用户交互限制

*   在AI处于"正在计算..."或"正在输入..."状态（即从接收第一个思考片段到正文回复完全结束的整个过程）时，用户**不能通过发送新消息等操作打断**当前的AI处理流程。系统应不响应新的用户输入，直至当前轮次处理完毕。

### 5.5. 适用模型与条件

*   此"思考过程可视化"功能**仅适用于**那些后端会实际发送"思考片段"数据的模型。
*   对于没有"思考"阶段或后端不发送"思考片段"的模型，聊天界面不应显示"正在计算..."状态及思考内容折叠区，交互流程维持现状。前端需能根据消息片段的 `type` 动态判断是否激活此UI。

### 5.6. 数据交互 (后端配合)

*   后端需在 `MessageFragmentVo` (通过 `/queryStream` 推送) 中定义新的 `type` 值以明确标识"思考片段"。
*   思考片段的 `content` 字段将包含单步思考的文本内容。

### 5.7. 错误处理 (在思考阶段)

*   如果在"思考"阶段（即在收到第一个"正文片段"之前），后端通过 `/queryStream` 推送了一个表示错误的片段（例如，`type: 10`）：
    *   "正在计算..."状态应更新以反映错误（例如，显示"计算错误"或直接展示错误信息）。
    *   错误内容可以考虑展示在原思考内容区域，或者通过标准错误提示组件（如 `GlowAlert`）显示。
    *   此时不应再转换为"正在输入..."状态。

## 6. 非功能性需求

*   界面响应应及时，状态切换流畅。
*   思考内容展示区的展开/折叠操作应顺滑。

## 7. 待讨论/未来考虑

*   思考片段 `content` 的具体格式（纯文本、Markdown、或其他结构化标记）以支持更丰富的展示。
*   如果思考步骤非常多，在展开状态下是否需要内部滚动或分页。

## 8.验收标准

1.  当与支持思考过程的模型交互时，在AI发送实际回复前，用户能看到"正在计算..."的状态提示。
2.  在"正在计算..."状态期间，AI消息区域上方出现一个默认折叠的思考内容区。
3.  用户可以点击展开/收起该区域以查看/隐藏思考步骤。
4.  思考步骤会随着后端推送的"思考片段"动态增量加载到该区域。
5.  当AI开始发送第一个正文回复片段时，"正在计算..."状态切换为"正在输入..."，正文在主消息区显示。
6.  AI回复完成后，思考内容区域及其内容依然保留在AI消息上方，用户仍可查看。
7.  在AI思考或回复过程中，用户无法发送新消息打断当前流程。
8.  对于不支持思考过程的模型，不显示"正在计算..."状态和思考内容区。
9.  若在思考阶段发生错误，错误信息能得到恰当的展示，且流程中止。 