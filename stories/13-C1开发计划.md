# C1模型变体参数管理系统开发计划

## 项目概述
基于需求文档《13-C1模型变体参数管理系统需求文档.md》，实现多AI模型参数配置管理系统，支持分层配置策略和模板化批量管理。

## 已完成工作

### ✅ 第一阶段：数据库设计优化（2025-01-XX）

#### 1. 数据库唯一索引设计
**目标**：确保数据一致性，防止重复配置，优化查询性能

**完成内容**：
1. **ModelVariantParamPo 参数实例表索引**
   - `idx_model_variant_param_unique`：核心唯一约束 `(model_variant_id, param_key, user_id, player_id)`
   - `idx_model_variant_param_model_user`：查询优化索引 `(model_variant_id, user_id, player_id)`
   - `idx_model_variant_param_seq`：排序索引 `(seq)`

2. **ModelVariantParamTemplatePo 参数模板表索引**
   - `idx_template_user_name_unique`：模板名称唯一约束 `(user_id, name)`
   - `idx_template_player`：玩家查询索引 `(player_id)`
   - `idx_template_user`：用户查询索引 `(user_id)`

3. **ModelVariantParamTemplateValuePo 模板值表索引**
   - `idx_template_value_param_unique`：模板内参数键唯一约束 `(template_id, param_key)`
   - `idx_template_value_template`：模板查询索引 `(template_id)`
   - `idx_template_value_seq`：排序索引 `(seq)`

**业务价值**：
- 防止参数配置重复冲突
- 确保模板名称在用户范围内唯一
- 优化常用查询路径性能
- 在数据库层面强制执行业务规则

## 待开发任务

### 🔄 第二阶段：Controller接口设计与DTO/VO定义（进行中）
**目标**：明确API边界，定义完整的数据传输对象，遵循项目代码规范

**控制器设计原则**：
- 使用@RestController和@RequestMapping定义路径前缀
- 所有接口方法使用@PostMapping注解
- 参数统一使用@RequestBody @Valid接收Dto对象
- 使用@RequirePermissionRest进行权限控制
- 返回值统一使用Result包装
- 管理员接口放在`/admin/`路径下

**已完成**：
✅ **ModelVariantParamController完整实现**（仅参数管理部分）
- AdminModelVariantParamController（4个接口完整实现）
- ModelVariantParamRepository（包含完整的JPQL查询）
- AdminModelVariantParamService（包含完整的业务逻辑）
- GetModelVariantParamListDto
- SaveModelVariantParamDto
- GetModelVariantParamListVo（包含globalVal和userVal字段）
- GetModelVariantParamDetailsVo

✅ **BUG修复记录**（2025-01-XX）
1. **接口参数修正**：
   - `removeModelVariantParam`接口改为传入`modelVariantId`、`paramKey`、`global`参数
   - `getModelVariantParamDetails`接口改为传入`modelVariantId`、`paramKey`、`global`参数
   - 创建新DTO：`GetModelVariantParamDetailsDto`、`RemoveModelVariantParamDto`

2. **数据合并逻辑修正**：
   - `getModelVariantParamList`接口将同一个`modelVariantId`的全局与用户值合并为一条记录
   - 在Service层实现参数键分组合并逻辑，避免产生多条记录

3. **字段命名统一**：
   - 统一使用"全局值"（globalVal）和"用户值"（userVal）命名
   - `GetModelVariantParamDetailsVo`添加`global`字段用于回显参数类型

4. **Repository方法补充**：
   - 添加`findByModelVariantIdAndParamKeyAndUserIsNullAndPlayerIsNull`查询全局参数
   - 添加`findByModelVariantIdAndParamKeyAndUserIdAndPlayerId`查询用户参数
   - 添加`getModelVariantParamListForMerge`返回基础数据供Service层合并

✅ **BUG2修复记录**（2025-01-XX）
1. **移除ID依赖**：
   - `GetModelVariantParamListVo`移除`id`字段，不再返回数据库ID
   - `SaveModelVariantParamDto`移除`id`字段，不再使用ID编辑

2. **三要素定位策略**：
   - 现在通过三要素定位参数：1.变体ID 2.参数键 3.global标识
   - `saveModelVariantParam`方法改为通过三要素查找现有参数，而不是ID
   - 自动判断新增还是编辑：存在则编辑，不存在则新增

3. **简化Repository**：
   - 移除不再需要的唯一性检查方法
   - 保留必要的三要素查询方法
   - 清理了重复和过时的查询方法

✅ **权限枚举补充**（仅参数管理权限）
- `ADMIN_MODEL_VARIANT_PARAM_VIEW` - 查看模型变体参数
- `ADMIN_MODEL_VARIANT_PARAM_SAVE` - 新增/编辑模型变体参数  
- `ADMIN_MODEL_VARIANT_PARAM_DELETE` - 删除模型变体参数

**待实现**：
🔄 **模板管理功能**
- ModelVariantParamTemplateController（模板管理）
- ModelVariantParamTemplateValueController（模板值管理）
- 对应的Repository、Service、DTO、VO
- 模板管理相关权限枚举

**任务清单**：

#### 1. ModelVariantParamController (参数管理)
**路径前缀**: `/admin/model/variant/param`
**接口设计**:
- `getModelVariantParamList` - 查询模型变体参数列表，VO中包含全局值和我的值 (权限: admin:model:variant:param:view)
- `getModelVariantParamDetails` - 查询参数详情 (权限: admin:model:variant:param:save)
- `saveModelVariantParam` - 保存参数配置，可保存全局或个人参数 (权限: admin:model:variant:param:save)
- `removeModelVariantParam` - 删除参数配置 (权限: admin:model:variant:param:delete)

#### 2. ModelVariantParamTemplateController (模板管理)
**路径前缀**: `/admin/model/variant/param/template`
**接口设计**:
- `getTemplateList` - 查询参数模板列表，包含全局模板和我的模板 (权限: admin:model:variant:param:template:view)
- `getTemplateDetails` - 查询模板详情 (权限: admin:model:variant:param:template:save)
- `saveTemplate` - 保存参数模板 (权限: admin:model:variant:param:template:save)
- `removeTemplate` - 删除参数模板 (权限: admin:model:variant:param:template:delete)
- `applyTemplateToGlobal` - 应用模板为全局默认参数 (权限: admin:model:variant:param:template:apply)
- `applyTemplateToPersonal` - 应用模板为个人参数 (权限: admin:model:variant:param:template:apply)

#### 3. ModelVariantParamTemplateValueController (模板值管理)
**路径前缀**: `/admin/model/variant/param/template/value`
**接口设计**:
- `getTemplateValueList` - 查询模板参数值列表 (权限: admin:model:variant:param:template:view)
- `getTemplateValueDetails` - 查询模板参数值详情 (权限: admin:model:variant:param:template:save)
- `saveTemplateValue` - 保存模板参数值 (权限: admin:model:variant:param:template:save)
- `removeTemplateValue` - 删除模板参数值 (权限: admin:model:variant:param:template:save)

#### 4. DTO设计 (com.ksptool.ql.biz.model.dto)
**参数管理相关**:
- `GetModelVariantParamListDto` - 查询参数列表请求
- `SaveModelVariantParamDto` - 保存参数请求

**模板管理相关**:
- `GetTemplateListDto` - 查询模板列表请求
- `SaveTemplateDto` - 保存模板请求
- `ApplyTemplateToGlobalDto` - 应用模板为全局默认请求
- `ApplyTemplateToPersonalDto` - 应用模板为个人参数请求

**模板值管理相关**:
- `GetTemplateValueListDto` - 查询模板值列表请求
- `SaveTemplateValueDto` - 保存模板值请求

#### 5. VO设计 (com.ksptool.ql.biz.model.vo)
**参数相关**:
- `GetModelVariantParamListVo` - 参数列表响应（包含globalValue和myValue两个字段）
- `GetModelVariantParamDetailsVo` - 参数详情响应

**模板相关**:
- `GetTemplateListVo` - 模板列表响应（包含全局模板和我的模板）
- `GetTemplateDetailsVo` - 模板详情响应

**模板值相关**:
- `GetTemplateValueListVo` - 模板值列表响应
- `GetTemplateValueDetailsVo` - 模板参数值详情响应

### 🔄 第三阶段：基础Repository创建
**目标**：创建基础数据访问层，为Service层提供基础支持

**任务清单**：
1. **ModelVariantParamRepository**
   - 继承JpaRepository<ModelVariantParamPo, Long>
   - 使用@Repository注解

2. **ModelVariantParamTemplateRepository**
   - 继承JpaRepository<ModelVariantParamTemplatePo, Long>
   - 使用@Repository注解

3. **ModelVariantParamTemplateValueRepository**
   - 继承JpaRepository<ModelVariantParamTemplateValuePo, Long>
   - 使用@Repository注解

4. **ModelVariantRepository** (如果不存在)
   - 继承JpaRepository<ModelVariantPo, Long>
   - 使用@Repository注解

### 🔄 第四阶段：Service层实现与Repository补充
**目标**：实现核心业务逻辑，根据实际需求补充Repository方法

**任务清单**：
1. **ModelVariantParamService实现**
   - 使用@Service注解，不创建接口
   - 参数优先级解析逻辑
   - 参数类型转换工具
   - 用户参数CRUD操作
   - 根据需求补充Repository查询方法

2. **ModelVariantParamTemplateService实现**
   - 使用@Service注解，不创建接口
   - 模板CRUD操作
   - 模板应用为全局默认参数（GM功能）
   - 模板应用为玩家个性化参数
   - 权限验证逻辑
   - 根据需求补充Repository查询方法

3. **Repository方法补充**
   - 按需添加复杂查询方法
   - 使用@Query注解，JPQL语句必须使用多行字符串
   - 查询参数使用@Param注解标注
   - 复杂查询直接投影到Vo对象
   - 方法命名以get开头

### 🔄 第五阶段：Controller实现
**目标**：实现Controller逻辑，连接Service层与前端

**任务清单**：
1. **管理员Controller实现**
   - 实现所有管理员参数和模板管理接口
   - 参数校验和异常处理
   - 权限控制集成
   - 使用try-catch处理BizException

2. **玩家Controller实现**
   - 实现所有玩家参数和模板管理接口
   - 个人权限验证
   - 数据隔离确保

### 🔄 第六阶段：测试与优化
**目标**：确保功能正确性和性能表现

**任务清单**：
1. 单元测试编写
2. 集成测试验证
3. 性能测试优化
4. 边界条件测试

## 开发顺序说明

### 新的开发策略优势
1. **接口优先设计**：明确API契约，避免后期接口变更
2. **遵循项目规范**：统一使用@PostMapping、Result响应、权限控制等
3. **分层权限管理**：管理员和玩家接口分离，权限控制清晰
4. **DTO/VO先行**：数据结构清晰，指导后续开发

### 实施步骤
1. 先创建所有Controller，方法体返回null，但接口契约完整
2. 创建基础Repository（仅继承JpaRepository）
3. 实现Service时，发现Repository方法不足就补充
4. 最后实现Controller具体逻辑

## 技术规范遵循
- SpringBoot 3.4.1
- Controller使用@RestController，统一@PostMapping
- 使用@RequirePermissionRest进行权限控制
- 参数统一使用@RequestBody @Valid接收Dto
- 返回值统一使用Result包装
- 使用assign(source,target)进行对象映射
- 禁用三元表达式，使用普通if
- DTO接收数据，VO响应数据
- 使用HibernateValidation进行参数校验
- Repository使用JPQL多行字符串
- Service使用@Service注解，不创建接口

## 权限设计说明
- **管理员权限模式**：`admin:model:variant:param:*` 和 `admin:model:variant:param:template:*`
- **玩家权限**：通过登录用户身份自动验证，无需额外权限注解
- **数据隔离**：玩家只能操作自己的数据，管理员可以操作全局数据

### 已实现的权限列表
**模型变体参数管理权限**：
- `admin:model:variant:param:view` - 查看模型变体参数列表和详情
- `admin:model:variant:param:save` - 新增和编辑模型变体参数（全局/个人）
- `admin:model:variant:param:delete` - 删除模型变体参数配置

### 待实现的权限列表
**模型变体参数模板管理权限**：
- `admin:model:variant:param:template:view` - 查看参数模板列表和模板值（待实现）
- `admin:model:variant:param:template:save` - 新增和编辑参数模板及模板值（待实现）
- `admin:model:variant:param:template:delete` - 删除参数模板（待实现）
- `admin:model:variant:param:template:apply` - 应用模板为全局默认或个人参数（待实现）

## 风险与注意事项
1. **数据一致性**：模板应用时的批量操作需要事务保证
2. **权限控制**：确保用户只能操作自己的模板和参数
3. **性能考虑**：大量参数查询时的N+1问题
4. **类型转换**：参数值字符串与实际类型的转换准确性
5. **接口设计**：初期接口设计需要充分考虑业务场景，避免后期大幅调整
