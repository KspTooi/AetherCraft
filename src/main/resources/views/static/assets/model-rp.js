import{d as le,u as se,c as g,r as b,q as ne,B as we,a as c,F as j,b as a,s as ae,e as U,L as W,w as G,f as V,g as fe,i as F,x as $e,t as z,T as Re,h as H,n as q,j as ce,k as re,o as r,_ as ie,D as he,l as Y,C as ye,m as ke,v as Te,p as Ce,A as _e}from"./index.js";import{m as Ie,M as Me}from"./marked.esm.js";const Se={class:"thread-list-container"},xe={class:"thread-items-wrapper"},Be={key:0,class:"loading-indicator"},Pe={key:1,class:"empty-thread-tip"},De={key:2,class:"thread-items"},Ae=["onClick","title"],Ee=["src","alt"],He={key:1,class:"bi bi-person"},Le={class:"thread-content"},Ne={class:"thread-title"},Oe={key:0,class:"thread-time"},Ue={class:"menu-wrapper"},qe=["onClick"],ze={key:0,class:"menu-teleport-container"},Ve={class:"menu-title"},je=le({__name:"ModelRpThreadList",props:{currentRoleId:{},currentThreadId:{},isMobileMenuOpen:{type:Boolean}},emits:["roleChecked","roleEdit","roleConfig","threadManage","startNewSession","toggleMobileMenu","threadEdit","threadDelete","threadChecked"],setup(K,{expose:A,emit:$}){re(f=>({c8ee53ee:`rgba(${u.value.split("(")[1].split(")")[0]}, 0.1)`,"50320aac":_.value,"3ab88c10":d.value,"3c6ff4a9":u.value,"3cb68e82":p.value,"04880656":T.value,"54dbdc4c":`rgba(${u.value.split("(")[1].split(")")[0]}, 0.15)`,"34b1cc1c":S.value,"0d1ecee4":P.value,f460bc14:L.value,"4d762f3a":`rgba(${T.value.split("(")[1].split(")")[0].split(",").join(", ")}, 0.5)`,f103aa3e:`rgba(${L.value.split("(")[1].split(")")[0]}, 0.2)`}));const k=se(),u=g(()=>k.primaryColor),T=g(()=>k.activeColor),p=g(()=>k.primaryHover),_=g(()=>k.primaryButton),d=g(()=>k.primaryButtonBorder);g(()=>k.sideBlur),g(()=>k.textareaColor);const S=g(()=>k.menuColor),L=g(()=>k.menuActiveColor),P=g(()=>k.menuBlur),x=K,B=$,M=b([]),N=b(!1),w=b(null),D=b(""),i=b({top:"0px",left:"0px"});b([]);const t=b(!1),l=async()=>{N.value=!0;try{console.log("开始加载角色列表...");const f=await H.post("/model/rp/getRoleList",{page:1,size:100});if(f.data.code===0){const e=f.data.data;M.value=e.rows||[],console.log(`角色列表加载成功，共 ${M.value.length} 个角色`),M.value.length===0&&console.log("角色列表为空，请先创建角色")}else console.error("加载角色列表失败:",f.data.message)}catch(f){console.error("加载角色列表失败:",f)}finally{N.value=!1}},o=f=>{if(!f)return"";try{const e=new Date(f);if(isNaN(e.getTime()))return"";const n=e.getFullYear(),m=(e.getMonth()+1).toString().padStart(2,"0"),s=e.getDate().toString().padStart(2,"0"),y=e.getHours().toString().padStart(2,"0"),h=e.getMinutes().toString().padStart(2,"0");return`${n}年${m}月${s}日 ${y}:${h}`}catch(e){return console.error("时间格式化错误:",e),""}},v=()=>{window.location.href="/dashboard?redirect=/panel/model/role/list"},R=f=>{if(console.log(`角色点击: roleId=${f}, 当前roleId=${x.currentRoleId}`),String(f)===String(x.currentRoleId)){console.log("点击了当前已选中的角色，不触发事件");return}B("roleChecked",f)},E=()=>{ee(),x.isMobileMenuOpen&&(console.log("关闭移动端菜单"),B("toggleMobileMenu"))},X=f=>{B("roleEdit",f),E()},Q=f=>{B("roleConfig",f),E()},ue=(f,e)=>{B("threadManage",f,e),E()},ve=f=>{console.log(`触发startNewSession事件: roleId=${f}`),B("startNewSession",f),E()},me=(f,e,n)=>{if(n.stopPropagation(),t.value=!1,w.value===f){w.value=null;return}w.value=f,D.value=e;const m=window.innerWidth,s=window.innerHeight,y=n,h=y.pageX,I=y.pageY,C=150,O=160,J=h+C+5>m,oe=I+O+5>s;let be=I,de=h;J&&(de=h-C),oe&&(be=I-O),de<10&&(de=10),i.value={top:`${be}px`,left:`${de}px`},document.addEventListener("click",Z)},Z=f=>{ee(),document.removeEventListener("click",Z)},ee=()=>{w.value=null,t.value=!1},ge=f=>{B("threadEdit",f),E()},pe=f=>{B("threadDelete",f),E()},te=f=>{B("threadChecked",f),E()};return ne(()=>{l()}),we(()=>{document.removeEventListener("click",Z)}),A({loadRoleList:l,roles:M}),(f,e)=>(r(),c(j,null,[a("div",Se,[U(W,{class:"manage-thread-btn",corners:["bottom-left","bottom-right"],"corner-size":"15px","background-color":_.value,"border-color":d.value,onClick:v},{default:G(()=>e[7]||(e[7]=[V(" 管理角色 ")])),_:1},8,["background-color","border-color"]),a("div",xe,[N.value?(r(),c("div",Be,e[8]||(e[8]=[a("i",{class:"bi bi-arrow-repeat spinning"},null,-1),V(" 加载中... ")]))):M.value.length===0?(r(),c("div",Pe,[e[10]||(e[10]=a("i",{class:"bi bi-person-plus"},null,-1)),e[11]||(e[11]=a("div",{class:"tip-text"},"您还没有创建角色",-1)),U(W,{class:"create-thread-btn",corners:["bottom-left","bottom-right"],"corner-size":"15px","background-color":_.value,"border-color":d.value,"glow-color":p.value,onClick:v},{default:G(()=>e[9]||(e[9]=[V(" 创建角色 ")])),_:1},8,["background-color","border-color","glow-color"])])):(r(),c("div",De,[(r(!0),c(j,null,fe(M.value,n=>(r(),c("div",{key:n.id,onClick:m=>R(n.id),class:q(["thread-item",{active:String(n.id)===String(f.currentRoleId)}]),title:n.name},[a("div",{class:q(["role-avatar",{"no-image":!n.avatarPath}])},[n.avatarPath?(r(),c("img",{key:0,src:n.avatarPath,alt:n.name},null,8,Ee)):(r(),c("i",He))],2),a("div",Le,[a("div",Ne,z(n.name),1),n.createTime?(r(),c("div",Oe,z(o(n.createTime)),1)):F("",!0)]),a("div",Ue,[a("button",{class:"menu-btn",onClick:ce(m=>me(n.id,n.name,m),["stop"])},e[12]||(e[12]=[a("i",{class:"bi bi-three-dots-vertical"},null,-1)]),8,qe)])],10,Ae))),128))]))])]),(r(),ae(Re,{to:"body"},[w.value!==null?(r(),c("div",ze,[a("div",{class:"global-menu-overlay",onClick:ee}),a("div",{class:"global-menu",style:$e(i.value)},[e[18]||(e[18]=a("div",{class:"menu-top-border"},null,-1)),t.value?(r(),c(j,{key:1},[e[15]||(e[15]=a("div",{class:"menu-title"},"会话操作",-1)),e[16]||(e[16]=a("div",{class:"menu-divider"},null,-1)),a("div",{class:"menu-item",onClick:e[4]||(e[4]=n=>te(w.value))}," 打开会话 "),e[17]||(e[17]=a("div",{class:"menu-divider"},null,-1)),a("div",{class:"menu-item",onClick:e[5]||(e[5]=n=>ge(w.value))}," 编辑会话 "),a("div",{class:"menu-item",onClick:e[6]||(e[6]=n=>pe(w.value))}," 删除会话 ")],64)):(r(),c(j,{key:0},[a("div",Ve,z(D.value),1),e[13]||(e[13]=a("div",{class:"menu-divider"},null,-1)),a("div",{class:"menu-item",onClick:e[0]||(e[0]=n=>ve(w.value))}," 开始新会话 "),a("div",{class:"menu-item",onClick:e[1]||(e[1]=n=>ue(w.value,D.value))}," 管理全部会话 "),e[14]||(e[14]=a("div",{class:"menu-divider"},null,-1)),a("div",{class:"menu-item",onClick:e[2]||(e[2]=n=>X(w.value))}," 编辑角色 "),a("div",{class:"menu-item",onClick:e[3]||(e[3]=n=>Q(w.value))}," 设置模型角色 ")],64))],4)])):F("",!0)]))],64))}}),Ke=ie(je,[["__scopeId","data-v-bd8bb6c5"]]),Ye={class:"chat-messages-wrapper"},Fe={key:0,class:"empty-state"},We={key:1,class:"empty-state"},Ge={key:2,class:"empty-state"},Je={class:"message-header"},Xe=["src","alt"],Qe={key:1,class:"bi bi-person"},Ze={class:"message-content"},et={class:"name"},tt={class:"time"},ot={key:0,class:"typing"},at={key:0},lt={key:0},st=["innerHTML"],nt={key:1},rt=["onUpdate:modelValue","onInput"],it={class:"message-actions"},dt=["onClick","disabled"],ct=["onClick","disabled"],ut=["onClick","disabled"],vt=["onClick","disabled"],mt=["onClick","disabled"],gt=le({__name:"ModelRpMsgBox",props:{messages:{},currentThreadId:{},currentRoleId:{},isEditing:{type:Boolean}},emits:["messageEdit","messageRemove","regenerate","scrollToBottom"],setup(K,{expose:A,emit:$}){re(t=>({c9d22bac:Ce(k).getMessageHoverUser(),"19ae1d8c":Ce(k).getMessageHoverModel()}));const k=se();k.getMessageHoverUser||(k.getMessageHoverUser=()=>"rgba(0, 0, 0, 0.1)"),k.getMessageHoverModel||(k.getMessageHoverModel=()=>"rgba(50, 50, 60, 0.1)");const u=K,T=$,p=b(null),_=b(null),d=b(null),S=g(()=>u.messages.some(t=>t.isTyping===!0));he(()=>u.currentThreadId,t=>{t&&(console.log(`消息框监听到threadId变化: ${t}`),Y(()=>{i()}))}),he(()=>u.messages.length,t=>{console.log(`消息数量变化: ${t}`),Y(()=>{i()})});const L=t=>{if(!t)return"";try{const l=new Date(t);if(isNaN(l.getTime()))return"";const o=l.getFullYear(),v=(l.getMonth()+1).toString().padStart(2,"0"),R=l.getDate().toString().padStart(2,"0"),E=l.getHours().toString().padStart(2,"0"),X=l.getMinutes().toString().padStart(2,"0"),Q=l.getSeconds().toString().padStart(2,"0");return`${o}年${v}月${R}日 ${E}:${X}:${Q}`}catch(l){return console.error("时间格式化错误:",l),""}},P=t=>t?Ie.parse(t):"",x=t=>{t.isEditing=!0,t.editContent=t.content,Y(()=>{if(_.value&&_.value.length>0){const l=_.value[0];l.focus(),D(l,t);const o=u.messages[u.messages.length-1];o&&o.id===t.id&&T("scrollToBottom")}})},B=t=>{if(!t.editContent||t.editContent.trim()===""){alert("消息内容不能为空");return}if(t.content===t.editContent){t.isEditing=!1;return}t.id&&T("messageEdit",t.id,t.editContent)},M=t=>{t.editContent=t.content,t.isEditing=!1},N=async t=>{if(!t.id)return;await d.value.showConfirm({title:"删除消息",content:"确定要删除这条消息吗？此操作不可恢复。",confirmText:"删除",cancelText:"取消"})&&T("messageRemove",t.id)},w=t=>{T("regenerate",t)},D=(t,l)=>{if(!t)return;const o=document.createElement("div");o.className="text",o.style.position="absolute",o.style.visibility="hidden",o.style.width=t.offsetWidth+"px",o.style.fontSize="14px",o.style.lineHeight="1.5",o.style.padding="8px",l.role==="user"?o.textContent=l.content:o.innerHTML=P(l.content),document.body.appendChild(o);const v=o.offsetHeight,R=60,E=300;t.style.height=Math.min(Math.max(v,R),E)+"px",document.body.removeChild(o)},i=()=>{Y(()=>{const t=p.value;t&&(t.scrollTop=t.scrollHeight,console.log("滚动到底部"))})};return A({scrollToBottom:i}),ne(()=>{console.log("消息框组件挂载完成，初始化滚动"),Y(()=>{i()})}),(t,l)=>(r(),c("div",Ye,[t.currentRoleId?t.currentThreadId?t.messages.length===0?(r(),c("div",Ge,l[2]||(l[2]=[a("i",{class:"bi bi-chat-dots"},null,-1),a("div",{class:"title"},"暂无消息",-1),a("div",{class:"subtitle"},"在下方输入框输入内容开始角色扮演对话",-1)]))):(r(),c("div",{class:"chat-messages messages-container-fade-in",ref_key:"messagesContainer",ref:p,key:`thread-${t.currentThreadId}`},[(r(!0),c(j,null,fe(t.messages,(o,v)=>(r(),c("div",{key:`msg-${o.id||v}`,class:q(["message","message-hover-effect",o.role==="user"?"user":"assistant",{editing:o.isEditing}])},[a("div",Je,[a("div",{class:q(["avatar",{"no-image":!o.avatarPath}])},[o.avatarPath?(r(),c("img",{key:0,src:o.avatarPath,alt:o.name},null,8,Xe)):(r(),c("i",Qe))],2)]),a("div",Ze,[a("div",et,[V(z(o.name)+" ",1),a("span",tt,z(L(o.createTime)),1),o.isTyping?(r(),c("span",ot,l[3]||(l[3]=[V("正在输入"),a("span",{class:"typing-dots"},[a("span",null,"."),a("span",null,"."),a("span",null,".")],-1)]))):F("",!0)]),o.isEditing?(r(),c("div",nt,[ke(a("textarea",{class:"editable-content","onUpdate:modelValue":R=>o.editContent=R,ref_for:!0,ref_key:"editTextarea",ref:_,onInput:R=>D(R.target,o)},null,40,rt),[[Te,o.editContent]])])):(r(),c("div",at,[!o.isTyping||o.hasReceivedData?(r(),c("div",{key:0,class:q(["text",{user:o.role==="user"}])},[o.role==="user"?(r(),c("div",lt,z(o.content),1)):(r(),c("div",{key:1,innerHTML:P(o.content)},null,8,st))],2)):F("",!0)]))]),a("div",it,[o.isEditing?(r(),c(j,{key:1},[a("button",{class:"message-confirm-btn",onClick:R=>B(o),disabled:t.isEditing||S.value,title:"确认编辑"},l[7]||(l[7]=[a("i",{class:"bi bi-check-lg"},null,-1)]),8,vt),a("button",{class:"message-cancel-btn",onClick:R=>M(o),disabled:t.isEditing||S.value,title:"取消编辑"},l[8]||(l[8]=[a("i",{class:"bi bi-x-lg"},null,-1)]),8,mt)],64)):(r(),c(j,{key:0},[v===t.messages.length-1?(r(),c("button",{key:0,class:"message-regenerate-btn",onClick:R=>w(o),disabled:S.value,title:"重新生成"},l[4]||(l[4]=[a("i",{class:"bi bi-arrow-repeat"},null,-1)]),8,dt)):F("",!0),a("button",{class:"message-edit-btn",onClick:R=>x(o),disabled:S.value,title:"编辑消息"},l[5]||(l[5]=[a("i",{class:"bi bi-pencil"},null,-1)]),8,ct),a("button",{class:"message-delete-btn",onClick:R=>N(o),disabled:S.value,title:"删除消息"},l[6]||(l[6]=[a("i",{class:"bi bi-trash"},null,-1)]),8,ut)],64))])],2))),128))])):(r(),c("div",We,l[1]||(l[1]=[a("i",{class:"bi bi-chat-square-text"},null,-1),a("div",{class:"title"},"正在初始化会话",-1),a("div",{class:"subtitle"},"请稍等片刻，或刷新页面重试",-1)]))):(r(),c("div",Fe,l[0]||(l[0]=[a("i",{class:"bi bi-people"},null,-1),a("div",{class:"title"},"请选择一个角色开始对话",-1),a("div",{class:"subtitle"},"从左侧列表选择一个角色，开始精彩的角色扮演对话",-1)]))),U(ye,{ref_key:"confirmModal",ref:d},null,512)]))}}),pt=ie(gt,[["__scopeId","data-v-b6c567e1"]]),ht={class:"chat-input"},ft={class:"chat-input-wrapper"},yt=["placeholder","disabled"],bt=le({__name:"ModelRpInput",props:{isLoading:{type:Boolean},isDisabled:{type:Boolean}},emits:["send","stop"],setup(K,{emit:A}){re(o=>({f996ce86:d.value,"3ca793dc":L.value,"41617e28":S.value,"5039a78d":k.value,"7a3e5d71":u.value}));const $=se(),k=g(()=>$.primaryColor),u=g(()=>$.activeColor),T=g(()=>$.primaryHover),p=g(()=>$.primaryButton),_=g(()=>$.primaryButtonBorder),d=g(()=>$.textareaColor),S=g(()=>$.textareaActive),L=g(()=>$.textareaBorder),P=g(()=>({"--corner-size":"15px","--corner-color":_.value})),x=K,B=A,M=b(""),N=b(null),w=b(!1),D=o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),i())},i=()=>{!M.value.trim()||x.isLoading||x.isDisabled||(B("send",M.value.trim()),M.value="",Y(()=>{l()}))},t=()=>{B("stop")},l=()=>{const o=N.value;if(!o)return;o.style.height="40px";const v=o.scrollHeight;if(v<=40||!M.value.trim()){o.style.height="40px",o.style.overflowY="hidden";return}v>120?(o.style.height="120px",o.style.overflowY="auto"):(o.style.height=v+"px",o.style.overflowY="hidden")};return ne(()=>{Y(()=>{l()})}),(o,v)=>(r(),c("div",ht,[a("div",ft,[ke(a("textarea",{"onUpdate:modelValue":v[0]||(v[0]=R=>M.value=R),ref_key:"messageTextarea",ref:N,placeholder:o.isDisabled?"请先选择一个角色":"在这里输入您的消息...",disabled:o.isLoading||o.isDisabled,onKeydown:D,onInput:l,onFocus:v[1]||(v[1]=R=>w.value=!0),onBlur:v[2]||(v[2]=R=>w.value=!1)},null,40,yt),[[Te,M.value]]),a("div",{class:q(["focus-border",{active:w.value}])},null,2),a("span",{class:q(["corner-fill corner-bl-fill",{active:w.value}]),style:$e(P.value)},null,6)]),o.isLoading?(r(),ae(W,{key:1,"background-color":"rgba(254, 79, 79, 0.3)","border-color":"rgba(254, 79, 79, 0.6)","glow-color":"rgba(254, 79, 79, 0.5)",corner:"bottom-right","corner-size":"15px",innerGlow:!0,onClick:t},{default:G(()=>v[4]||(v[4]=[V(" 停止生成 ")])),_:1})):(r(),ae(W,{key:0,disabled:!M.value.trim()||o.isDisabled,corner:"bottom-right","corner-size":"15px","background-color":p.value,"border-color":_.value,"glow-color":T.value,innerGlow:!0,particles:!0,onClick:i},{default:G(()=>v[3]||(v[3]=[V(" 发送 ")])),_:1},8,["disabled","background-color","border-color","glow-color"]))]))}}),Ct=ie(bt,[["__scopeId","data-v-03be2909"]]),$t={class:"thread-modal-container"},kt={class:"thread-modal-header"},Tt={class:"thread-modal-title"},wt={class:"thread-modal-body"},Rt={key:0,class:"loading-state"},_t={key:1,class:"empty-state"},It={key:2,class:"thread-list"},Mt=["onClick"],St={class:"thread-content"},xt={class:"thread-title"},Bt={key:0,class:"active-badge"},Pt={class:"thread-time"},Dt={key:0,class:"thread-message"},At={key:1,class:"thread-message"},Et={class:"thread-actions"},Ht=le({__name:"ModelRpThreadModal",props:{selectedRoleId:{},selectedRoleName:{}},emits:["threadChecked","close"],setup(K,{emit:A}){re(i=>({"7c24d8b6":k.value,"1906de98":u.value,"04670013":T.value,"0794dd33":`rgba(${k.value.split("(")[1].split(")")[0].split(",").map((t,l)=>l<3?Math.max(0,parseInt(t)-5):t).join(",")}, 1)`,"1328b8fe":`rgba(${T.value.split("(")[1].split(")")[0]}, 0.2)`,"1328bcbf":`rgba(${T.value.split("(")[1].split(")")[0]}, 0.3)`,"2b5a254c":`rgba(${k.value.split("(")[1].split(")")[0]}, 0.5)`,"2b5a1648":`rgba(${k.value.split("(")[1].split(")")[0]}, 0.7)`,"51eda4c7":`rgba(${T.value.split("(")[1].split(")")[0]}, 0.05)`,"1328c441":`rgba(${T.value.split("(")[1].split(")")[0]}, 0.5)`,"1328cbc3":`rgba(${T.value.split("(")[1].split(")")[0]}, 0.7)`}));const $=se();g(()=>$.primaryColor),g(()=>$.activeColor),g(()=>$.primaryHover),g(()=>$.brandColor),g(()=>$.primaryButton),g(()=>$.primaryButtonBorder),g(()=>$.mainBlur),g(()=>$.sideBlur),g(()=>$.textareaColor);const k=g(()=>$.modalColor),u=g(()=>$.modalBlur),T=g(()=>$.modalActive),p=K,_=A,d=b([]),S=b(!1),L=b(""),P=b(null),x=async()=>{if(p.selectedRoleId){S.value=!0;try{const i=await H.post("/model/rp/getModelRoleThreadList",{modelRoleId:p.selectedRoleId});if(i.data.code===0){d.value=i.data.data||[];const t=d.value.find(l=>l.active===1);t&&(L.value=t.id)}else console.error("加载会话列表失败:",i.data.message)}catch(i){console.error("加载会话列表失败:",i)}finally{S.value=!1}}},B=i=>{if(!i)return"";try{const t=new Date(i);if(isNaN(t.getTime()))return"";const l=t.getFullYear(),o=(t.getMonth()+1).toString().padStart(2,"0"),v=t.getDate().toString().padStart(2,"0"),R=t.getHours().toString().padStart(2,"0"),E=t.getMinutes().toString().padStart(2,"0");return`${l}年${o}月${v}日 ${R}:${E}`}catch(t){return console.error("时间格式化错误:",t),""}},M=i=>{_("threadChecked",p.selectedRoleId,i,!0)},N=async i=>{try{const t=d.value.find(v=>v.id===i);if(!t){console.error("找不到相应的会话");return}console.log(`激活会话: roleId=${p.selectedRoleId}, threadId=${i}, modelCode=${t.modelCode}`);const l={modelRoleId:Number(p.selectedRoleId),threadId:Number(i),modelCode:t.modelCode||"gemini-pro"};console.log("发送请求:",l);const o=await H.post("/model/rp/recoverRpChat",l);o.data.code===0?(console.log("激活会话成功, 响应:",o.data),d.value.forEach(v=>{v.active=v.id===i?1:0}),L.value=i,_("threadChecked",p.selectedRoleId,i,!1)):(console.error("激活会话失败:",o.data.message),alert("激活会话失败: "+o.data.message))}catch(t){console.error("激活会话失败:",t),alert("激活会话失败: "+(t instanceof Error?t.message:"未知错误"))}},w=async i=>{var o;if(!P.value||d.value.length<=1)return;const t=((o=d.value.find(v=>v.id===i))==null?void 0:o.title)||"未命名会话";if(await P.value.showConfirm({title:"删除会话",content:`您确定要删除 "${t}" 会话吗？此操作不可恢复。`,confirmText:"删除",cancelText:"取消"}))try{const v=await H.post("/model/rp/removeThread",{threadId:i});v.data.code===0?(d.value=d.value.filter(R=>R.id!==i),console.log("会话删除成功")):console.error("删除会话失败:",v.data.message)}catch(v){console.error("删除会话失败:",v)}},D=()=>{_("close")};return he(()=>p.selectedRoleId,i=>{i&&x()}),ne(()=>{p.selectedRoleId&&x()}),(i,t)=>(r(),c(j,null,[a("div",{class:"thread-modal-overlay",onClick:ce(D,["self"])},[a("div",$t,[t[4]||(t[4]=a("div",{class:"modal-glow-border"},null,-1)),a("div",kt,[a("h3",Tt,z(i.selectedRoleName)+" 的会话列表",1),a("button",{class:"thread-modal-close",onClick:D},"×")]),a("div",wt,[S.value?(r(),c("div",Rt,t[0]||(t[0]=[a("i",{class:"bi bi-arrow-repeat spinning"},null,-1),V(" 加载中... ")]))):d.value.length===0?(r(),c("div",_t,t[1]||(t[1]=[a("i",{class:"bi bi-chat-square-text"},null,-1),a("div",{class:"empty-title"},"还没有会话记录",-1),a("div",{class:"empty-desc"},"选择角色后发送消息自动创建会话",-1)]))):(r(),c("div",It,[(r(!0),c(j,null,fe(d.value,l=>(r(),c("div",{key:l.id,onClick:o=>M(l.id),class:q(["thread-item",{active:L.value===l.id}])},[a("div",St,[a("div",xt,[V(z(l.title||"未命名会话")+" ",1),l.active===1?(r(),c("span",Bt,"当前")):F("",!0)]),a("div",Pt,z(B(l.updateTime)),1),l.lastMessage?(r(),c("div",Dt,z(l.lastMessage),1)):(r(),c("div",At,"暂无对话内容"))]),a("div",Et,[l.active!==1?(r(),ae(W,{key:0,class:"thread-action-btn activate-btn",width:"30px",height:"30px","background-color":"transparent","border-color":"transparent",glowIntensity:"0",onClick:ce(o=>N(l.id),["stop"]),title:"激活会话"},{default:G(()=>t[2]||(t[2]=[a("i",{class:"bi bi-check-circle"},null,-1)])),_:2},1032,["onClick"])):F("",!0),U(W,{class:q(["thread-action-btn delete-btn",{disabled:d.value.length<=1}]),width:"30px",height:"30px","background-color":"transparent","border-color":"transparent",glowIntensity:"0",onClick:ce(o=>w(l.id),["stop"]),disabled:d.value.length<=1,title:"删除会话"},{default:G(()=>t[3]||(t[3]=[a("i",{class:"bi bi-trash"},null,-1)])),_:2},1032,["onClick","disabled","class"])])],10,Mt))),128))]))])])]),U(ye,{ref_key:"confirmModalRef",ref:P},null,512)],64))}}),Lt=ie(Ht,[["__scopeId","data-v-1373f167"]]),Nt={class:"chat-container"},Ot={class:"chat-layout"},Ut={class:"chat-main"},qt={class:"model-select"},zt={class:"chat-messages-wrapper"},Vt=le({__name:"model-rp",setup(K){re(e=>({"287d12da":k.value,"4360c416":$.value}));const A=se(),$=g(()=>A.mainBlur),k=g(()=>A.sideBlur);g(()=>A.primaryColor),g(()=>A.activeColor),g(()=>A.primaryHover),g(()=>A.primaryButton),g(()=>A.primaryButtonBorder),_e("finishLoading");const u=b([]),T=b(""),p=b(!1),_=b(null),d=b(null),S=b(!1),L=b(!1),P=b(null),x=b(null),B=b(!1),M=b(""),N=b(""),w=b(null),D=b(null),i=b({id:"",name:"助手",avatarPath:null});ne(async()=>{var m;console.log("组件挂载，开始加载角色列表...");try{const s=await H.post("/model/series/getModelSeries");s.data.code===0&&s.data.data.length>0&&(T.value=s.data.data[0].modelCode,console.log("设置默认模型:",T.value))}catch(s){console.error("获取模型列表失败:",s)}await((m=P.value)==null?void 0:m.loadRoleList());try{console.log("获取用户上次使用的会话和角色...");const s=await H.post("/model/rp/getRpLastStatus");if(s.data.code===0){const y=s.data.data;console.log("获取到上次状态:",y),y.lastRole&&y.lastThread&&(console.log(`恢复上次会话: 角色ID=${y.lastRole}, 会话ID=${y.lastThread}`),await l(y.lastRole,!1,y.lastThread))}}catch(s){console.error("获取上次会话状态失败:",s)}const n=new URLSearchParams(window.location.search).get("roleId");n&&(console.log(`从URL参数加载角色: ${n}`),await l(n,!1,null))});const t=()=>{d.value=null,u.value=[],p.value=!1},l=async(e,n=!1,m=null)=>{if(!e){console.error("角色ID不能为空");return}p.value=!0,t();try{const s={modelRoleId:e,modelCode:T.value||"gemini-pro"};m?(console.log(`加载指定会话, threadId: ${m}`),s.threadId=m):n===!0?(console.log("创建新会话, newThread=0"),s.newThread=0):(console.log("加载最近会话, newThread=1"),s.newThread=1),console.log("加载角色会话, 请求参数:",JSON.stringify(s));const y=await H.post("/model/rp/recoverRpChat",s);if(y.data.code===0){const h=y.data.data;if(console.log("API返回数据:",h),_.value=e,d.value=h.threadId?String(h.threadId):null,console.log("会话加载成功, threadId:",h.threadId),h.modelCode&&(console.log("从会话获取模型代码:",h.modelCode),T.value=h.modelCode),h.userRole&&(w.value={id:h.userRole.id,name:h.userRole.name||"用户",avatar:h.userRole.avatarPath}),P.value&&P.value.roles&&P.value.roles.length>0){const C=P.value.roles.find(O=>String(O.id)===String(e));C&&(console.log("缓存 AI 角色信息:",C),i.value={id:C.id,name:C.name||"助手",avatarPath:C.avatarPath||null})}let I=[];h.messages&&Array.isArray(h.messages)?(console.log(`API返回${h.messages.length}条messages:`,h.messages),I=h.messages):h.histories&&Array.isArray(h.histories)?(console.log(`API返回${h.histories.length}条histories:`,h.histories),I=h.histories):(console.log("API未返回消息列表，尝试检查非数组字段"),typeof h.message=="object"&&h.message!==null&&(console.log("找到单个消息对象:",h.message),I=[h.message])),I.length>0?(console.log(`找到${I.length}条消息`),I[0]&&(console.log("第一条消息字段:"),Object.keys(I[0]).forEach(C=>{console.log(`- ${C}: ${JSON.stringify(I[0][C])}`)})),u.value=I.map(C=>{const O=C.type===1||C.isUser===!1||!1,J=C.rawContent||C.content||"";return{id:C.id,role:O?"assistant":"user",content:J,name:C.name||(O?"助手":"用户"),avatarPath:C.avatarPath,createTime:C.createTime}}),console.log(`处理后消息列表(${u.value.length}条):`,u.value)):(console.log("API未返回任何可用消息"),u.value=[]),Y(()=>{var C;(C=x.value)==null||C.scrollToBottom()})}else console.error("加载会话失败, 错误码:",y.data.code,"错误信息:",y.data.message),t()}catch(s){console.error("加载会话失败:",s),t()}finally{p.value=!1}},o=()=>{S.value=!S.value},v=(e,n)=>{M.value=e,N.value=n,B.value=!0,console.log("打开会话管理模态框, 角色:",n,"(ID:",e,")")},R=()=>{B.value=!1},E=()=>{var e;(e=x.value)==null||e.scrollToBottom()},X=async e=>{try{if(console.log(`处理角色选择事件: roleId=${e}, 当前roleId=${_.value}, 当前threadId=${d.value}`),S.value&&o(),e===String(_.value)&&d.value){console.log("点击了当前已选中的角色，无需重新加载会话");return}d.value=null,console.log(`加载角色 ${e} 的会话...`),await l(e)}catch(n){console.error("加载角色会话失败:",n)}},Q=e=>{window.location.href=`/dashboard?redirect=/panel/model/role/list?id=${e}`},ue=async e=>{console.log("模型角色设置功能即将上线");try{await l(e,!0,null)}catch(n){console.error("创建新会话失败:",n)}},ve=async e=>{try{console.log(`开始新会话: roleId=${e}`),await l(e,!0,null)}catch(n){console.error("创建新会话失败:",n)}},me=async(e,n,m=!0)=>{console.log(`选择会话: roleId=${e}, threadId=${n}, 是否关闭模态框: ${m}`),await l(e,!1,n),m&&R()},Z=async(e,n)=>{if(d.value)try{L.value=!0;const m=await H.post("/model/rp/editHistory",{historyId:e,content:n});if(m.data.code===0){const s=u.value.find(y=>y.id===e);s&&(s.content=n,s.isEditing=!1),console.log("消息更新成功")}else console.error("更新消息失败:",m.data.message)}catch(m){console.error("更新消息失败:",m)}finally{L.value=!1}},ee=async e=>{if(!(!d.value||!D.value||!await D.value.showConfirm({title:"删除消息",content:"您确定要删除此消息吗？此操作不可恢复。",confirmText:"删除",cancelText:"取消"})))try{const m=await H.post("/model/rp/removeHistory",{historyId:e});m.data.code===0?(u.value=u.value.filter(s=>s.id!==e),console.log("消息删除成功")):console.error("删除消息失败:",m.data.message)}catch(m){console.error("删除消息失败:",m)}},ge=async e=>{var n,m;if(!(p.value||!d.value))try{p.value=!0;const s=u.value[u.value.length-1];if(s.role==="user"){console.log("最后一条是用户消息，直接根据它生成AI响应");const I={role:"assistant",content:"",name:i.value.name,avatarPath:i.value.avatarPath,createTime:new Date().toISOString(),isTyping:!0,hasReceivedData:!1};console.log("添加新的AI临时消息:",I),u.value.push(I),(n=x.value)==null||n.scrollToBottom();const C=await H.post("/model/rp/rpCompleteBatch",{threadId:d.value,model:T.value||"gemini-pro",queryKind:0});C.data.code===0?(console.log("生成请求成功"),await te(I)):(console.error("生成失败:",C.data.message),u.value.pop(),p.value=!1);return}if(s.role==="assistant"){if(console.log("最后一条是AI消息，删除它并创建新的临时消息"),s.id)try{await H.post("/model/rp/removeHistory",{historyId:s.id})}catch(I){console.error("删除最后一条AI消息失败，但继续执行重新生成:",I)}u.value.pop()}const y={role:"assistant",content:"",name:i.value.name,avatarPath:i.value.avatarPath,createTime:new Date().toISOString(),isTyping:!0,hasReceivedData:!1};console.log("添加新的AI临时消息:",y),u.value.push(y),(m=x.value)==null||m.scrollToBottom();const h=await H.post("/model/rp/rpCompleteBatch",{threadId:d.value,model:T.value||"gemini-pro",queryKind:3});h.data.code===0?(console.log("重新生成请求成功"),await te(y)):(console.error("重新生成失败:",h.data.message),u.value.pop(),p.value=!1)}catch(s){console.error("重新生成失败:",s),u.value.length>0&&u.value[u.value.length-1].isTyping&&u.value.pop(),p.value=!1}},pe=async e=>{var n,m,s,y;if(console.log("开始发送消息"),p.value||!d.value){console.log("无法发送消息："+(p.value?"正在加载中":"当前没有活动会话"));return}p.value=!0;try{const h=T.value||"gemini-pro",I={threadId:d.value,model:h,message:e,queryKind:0};console.log("发送消息请求参数:",I);const C=await H.post("/model/rp/rpCompleteBatch",I);if(console.log("接收到发送消息响应:",C.data),C.data.code===0){const O=C.data.data;console.log("后端返回的用户消息数据:",O);const J={id:O.historyId,role:"user",content:O.content||e,name:O.roleName||((n=w.value)==null?void 0:n.name)||"用户",avatarPath:O.roleAvatarPath||((m=w.value)==null?void 0:m.avatar),createTime:new Date().toISOString()};console.log("添加用户消息到消息列表:",J),u.value.push(J),(s=x.value)==null||s.scrollToBottom();const oe={role:"assistant",content:"",name:i.value.name,avatarPath:i.value.avatarPath,createTime:new Date().toISOString(),isTyping:!0,hasReceivedData:!1};console.log("添加AI临时消息:",oe),u.value.push(oe),(y=x.value)==null||y.scrollToBottom(),console.log("开始轮询AI响应..."),await te(oe)}else console.error("发送消息失败:",C.data),p.value=!1}catch(h){console.error("发送消息错误:",h),p.value=!1}},te=async e=>{var n;for(;p.value;)try{const m=await H.post("/model/rp/rpCompleteBatch",{threadId:d.value,queryKind:1});if(m.data.code===0){const s=m.data.data;if(!s){await new Promise(y=>setTimeout(y,500));continue}if(console.log("收到流式响应片段:",s),s.type===1){e.hasReceivedData||(e.hasReceivedData=!0,e.content="",s.historyId&&(e.id=s.historyId));const y=s.content||s.rawContent||"";y&&(console.log(`添加内容片段: "${y.substring(0,30)}..."`),e.content+=y),s.name&&(e.name=s.name),s.avatarPath&&(e.avatarPath=s.avatarPath),u.value=[...u.value],(n=x.value)==null||n.scrollToBottom()}else if(s.type===2){e.isTyping=!1,p.value=!1,s.historyId&&!e.id&&(console.log(`为消息附加历史ID: ${s.historyId}`),e.id=s.historyId),s.roleName&&(e.name=s.roleName),s.roleAvatarPath&&(e.avatarPath=s.roleAvatarPath&&s.roleAvatarPath.startsWith("/res/")?s.roleAvatarPath:s.roleAvatarPath?`/res/${s.roleAvatarPath}`:null),u.value=[...u.value],console.log("流式响应完成，最终消息:",e);break}}else{console.error("获取AI响应失败:",m.data.message),p.value=!1;break}}catch(m){console.error("获取AI响应错误:",m),p.value=!1;break}},f=async()=>{if(!(!p.value||!d.value))try{if(D.value&&!await D.value.showConfirm({title:"终止生成",content:"您确定要终止AI正在生成的回复吗？",confirmText:"终止",cancelText:"继续生成"}))return;await H.post("/model/rp/rpCompleteBatch",{threadId:d.value,queryKind:2}),console.log("已终止AI响应"),p.value=!1}catch(e){console.error("终止响应失败:",e),p.value=!1}};return(e,n)=>(r(),c("div",Nt,[a("div",Ot,[U(W,{class:"mobile-menu-btn",onClick:o,corners:["top-left"],"corner-size":"15px"},{default:G(()=>n[1]||(n[1]=[V(" 角色列表 ")])),_:1}),a("div",{class:q(["thread-list-mask",{show:S.value}]),onClick:o},null,2),a("div",{class:q(["thread-list",{show:S.value}])},[U(Ke,{ref_key:"threadListRef",ref:P,currentRoleId:_.value!==null?String(_.value):null,currentThreadId:d.value!==null?String(d.value):null,isMobileMenuOpen:S.value,onRoleChecked:X,onRoleEdit:Q,onRoleConfig:ue,onThreadManage:v,onStartNewSession:ve,onToggleMobileMenu:o},null,8,["currentRoleId","currentThreadId","isMobileMenuOpen"])],2),a("div",Ut,[a("div",qt,[U(Me,{modelValue:T.value,"onUpdate:modelValue":n[0]||(n[0]=m=>T.value=m)},null,8,["modelValue"])]),a("div",zt,[U(pt,{ref_key:"messagesRef",ref:x,messages:u.value,currentThreadId:d.value?String(d.value):null,currentRoleId:_.value?String(_.value):null,isEditing:L.value,onMessageEdit:Z,onMessageRemove:ee,onRegenerate:ge,onScrollToBottom:E},null,8,["messages","currentThreadId","currentRoleId","isEditing"])]),U(Ct,{isLoading:p.value,isDisabled:!d.value||!_.value,onSend:pe,onStop:f},null,8,["isLoading","isDisabled"])])]),B.value?(r(),ae(Lt,{key:0,selectedRoleId:M.value,selectedRoleName:N.value,onClose:R,onThreadChecked:me},null,8,["selectedRoleId","selectedRoleName"])):F("",!0),U(ye,{ref_key:"confirmModalRef",ref:D},null,512)]))}}),Yt=ie(Vt,[["__scopeId","data-v-d39f0ee3"]]);export{Yt as default};
