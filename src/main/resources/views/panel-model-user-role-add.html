<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" class="h-100">
<head>
    <title>添加用户角色 - Quick Launcher</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .role-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
        }
        .role-avatar-placeholder {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: var(--bs-gray-200);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: var(--bs-gray-600);
        }
    </style>
</head>
<body class="h-100">
    <!-- 引入控制台框架 -->
    <div th:replace="~{components/com-frame-control-panel :: control-panel(~{::content})}">
        <div th:fragment="content">
            <!-- 页面内容 -->
            <div class="container-fluid p-0">
                <!-- 消息提示组件已在panel-mvc-toasts.html中引入，通过控制面板框架自动加载 -->
                <div class="card shadow-sm">
                    <div class="card-header bg-white border-bottom pt-3 pb-2">
                        <div class="d-flex justify-content-between align-items-center px-3">
                            <h5 class="card-title mb-0 fw-bold text-dark">添加用户角色</h5>
                            <a th:href="@{/panel/model/user-role/list}" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-arrow-left me-1"></i>返回列表
                            </a>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div class="row justify-content-center">
                            <div class="col-md-8">
                                <form id="roleForm" th:action="@{/panel/model/user-role/save}" method="post" class="needs-validation" novalidate>
                                    <input type="hidden" id="roleId" name="id" th:value="${role != null ? role.id : ''}">
                                    
                                    <div class="mb-4 text-center">
                                        <div class="position-relative d-inline-block">
                                            <div class="avatar-preview mb-3 mx-auto" 
                                                 style="width:120px;height:120px;border-radius:50%;background:#f0f0f0;overflow:hidden;display:flex;align-items:center;justify-content:center;">
                                                <i class="bi bi-person" style="font-size:60px;color:#aaa;" id="avatarPlaceholder" th:style="${role != null && !#strings.isEmpty(role.avatarPath) ? 'display:none' : ''}"></i>
                                                <img id="avatarPreview" style="width:100%;height:100%;object-fit:cover;" 
                                                     th:src="${role != null ? role.avatarPath : ''}" 
                                                     th:style="${role != null && !#strings.isEmpty(role.avatarPath) ? '' : 'display:none'}">
                                            </div>
                                            <button type="button" class="btn btn-sm btn-primary position-absolute bottom-0 end-0"
                                                    onclick="document.getElementById('avatarUpload').click()">
                                                <i class="bi bi-camera"></i>
                                            </button>
                                            <input type="file" id="avatarUpload" accept="image/*" style="display:none"
                                                   onchange="previewAvatar(this)">
                                            <input type="hidden" id="avatarPath" name="avatarPath" th:value="${role != null ? role.avatarPath : ''}">
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="roleName" class="form-label">角色名称 <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="roleName" name="name" 
                                               placeholder="请输入角色名称" required
                                               th:value="${role != null ? role.name : ''}">
                                        <div class="invalid-feedback">请输入角色名称</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="roleDescription" class="form-label">角色描述</label>
                                        <textarea class="form-control" id="roleDescription" name="description" 
                                                  rows="3" placeholder="请输入角色描述"
                                                  th:text="${role != null ? role.description : ''}"></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="sortOrder" class="form-label">排序号</label>
                                        <input type="number" class="form-control" id="sortOrder" name="sortOrder" 
                                               placeholder="请输入排序号" 
                                               th:value="${role != null ? role.sortOrder : 0}">
                                    </div>
                                    
                                    <div class="mb-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="isDefault" name="isDefault"
                                                   th:checked="${role != null && role.isDefault == 1}">
                                            <label class="form-check-label" for="isDefault">
                                                设为默认角色
                                            </label>
                                            <div class="form-text">默认角色将作为新用户的初始角色</div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex justify-content-center mt-4">
                                        <button type="button" class="btn btn-outline-secondary me-2" onclick="resetForm()">
                                            重置
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-check-lg me-1"></i>保存
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 预览头像
        function previewAvatar(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('avatarPreview').src = e.target.result;
                    document.getElementById('avatarPreview').style.display = 'block';
                    document.getElementById('avatarPlaceholder').style.display = 'none';
                    
                    // 实际上传逻辑需要在此处添加
                    // 上传成功后设置avatarPath字段
                    // document.getElementById('avatarPath').value = '上传后的路径';
                    
                    // 模拟上传
                    uploadAvatar(input.files[0]);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // 上传头像
        function uploadAvatar(file) {
            // 创建FormData对象
            const formData = new FormData();
            formData.append('file', file);
            
            // 发送上传请求
            fetch('/panel/model/user-role/upload-avatar', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                if (result.code === 200) {
                    // 上传成功，设置头像路径
                    document.getElementById('avatarPath').value = result.data;
                } else {
                    // 上传失败
                    alert('头像上传失败：' + result.message);
                }
            })
            .catch(error => {
                console.error('上传错误:', error);
                alert('头像上传出错，请重试');
            });
        }
        
        // 重置表单
        function resetForm() {
            document.getElementById('roleForm').reset();
            document.getElementById('avatarPreview').style.display = 'none';
            document.getElementById('avatarPlaceholder').style.display = 'block';
            document.getElementById('avatarPath').value = '';
            document.getElementById('roleForm').classList.remove('was-validated');
        }
        
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化表单验证
            const forms = document.querySelectorAll('.needs-validation');
            Array.from(forms).forEach(form => {
                form.addEventListener('submit', event => {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        });
    </script>
</body>
</html> 